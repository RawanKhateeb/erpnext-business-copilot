# Recommendation Explanation Feature

## Overview

The **Recommendation Explanation Framework** provides transparent, data-driven explanations for every recommendation generated by ERPNext Copilot. Instead of just showing insights, the system now explains **WHY** each recommendation was made, using only actual data from ERPNext.

## Features

### 1. **Evidence-Based Reasoning**
- Every recommendation includes specific data points that led to it
- Uses ONLY data from ERPNext API - never invents numbers
- Shows exact calculations and comparisons

### 2. **Business-Friendly Language**
- Simple, clear explanations without jargon
- Structured format: Title ‚Üí Summary ‚Üí Reasons ‚Üí Next Actions
- Professional presentation suitable for management

### 3. **Data Integrity**
- Guarantees no made-up numbers or facts
- References exact fields from system data
- Traceable back to source transactions

## Output Format

### Standard Explanation Response

```json
{
  "explanation": {
    "title": "Why these recommendations?",
    "summary": "1-2 sentence summary of what the result means",
    "reasons": [
      {
        "recommendation": "Recommendation text",
        "evidence": "Exact data points from JSON showing why"
      },
      {
        "recommendation": "Another recommendation",
        "evidence": "More specific evidence"
      }
    ],
    "next_actions": [
      "Actionable step 1",
      "Actionable step 2",
      "Actionable step 3"
    ]
  }
}
```

## Supported Intents

### 1. **Total Spend** (`total_spend`)
Shows total spending across all purchase orders

**Example Explanation:**
```
Summary: Your organization has spent $2,350.00 across 5 purchase orders, 
with an average order value of $470.00.

Reasons:
1. Total spend across all purchase orders
   Evidence: $2,350.00 spent across 5 orders
2. Order completion status: 0 of 5 orders completed
   Evidence: 0.0% completion rate (0 completed, 5 pending)
3. Average purchase order size indicates spending patterns
   Evidence: Average order value: $470.00

Next Actions:
‚Ä¢ Review pending orders (5) to track delivery and invoicing progress
‚Ä¢ Analyze spending trends by supplier to identify cost optimization opportunities
```

### 2. **List Purchase Orders** (`list_purchase_orders`)
Displays all purchase orders with analysis

**Explanation includes:**
- Total number of POs
- Status distribution (Draft, To Receive, To Bill, Completed)
- Supplier diversity metrics
- Actionable follow-up items

### 3. **Price Anomalies** (`detect_price_anomalies`)
Identifies items priced significantly above historical average

**Explanation includes:**
- Number of anomalies detected
- Items flagged (20%+ above average)
- Normal-priced items
- Negotiation recommendations based on findings

### 4. **Delayed Orders** (`detect_delayed_orders`)
Tracks orders delayed past expected delivery date

**Explanation includes:**
- Number of delayed orders
- Total and average days overdue
- Supplier performance impact
- Follow-up actions by supplier

### 5. **List Views** (`list_customers`, `list_suppliers`, `list_items`, `list_sales_orders`)
Shows count and characteristics of each entity

**Explanation includes:**
- Total count
- Unique relationships (suppliers per order, customers, etc.)
- Performance analysis opportunities
- Strategic relationship management suggestions

## Implementation Details

### Backend: `app/recommendation_explainer.py`

**Main Function:**
```python
def explain_recommendations(intent: str, user_question: str, data: Dict[str, Any], 
                           insights: List[str], recommendations: List[str]) -> Dict[str, Any]:
    """
    Generate explanation for recommendations using only actual data.
    
    Returns structured explanation with title, summary, reasons, and next_actions.
    """
```

**Key Functions:**
- `explain_recommendations()` - Main orchestrator
- `format_explanation_text()` - Convert to readable text format

### Service Layer Integration: `app/copilot/service.py`

All major intents now include explanation generation:

```python
# Generate explanation
explanation = explain_recommendations(
    intent=intent, 
    user_question=user_question, 
    data=data,
    insights=insights,
    recommendations=insights
)

# Include in response
return {
    "intent": intent,
    "answer": answer,
    "insights": insights,
    "data": data,
    "explanation": explanation,  # NEW
    "next_questions": next_questions
}
```

### Frontend: `app/templates/copilot.html`

**New HTML Section:**
```html
<div id="explanationSection" class="explanation-section hidden">
    <h3>üìã Why These Recommendations?</h3>
    <div id="explanationContent"></div>
</div>
```

**CSS Styling:**
- `.explanation-section` - Container styling
- `.explanation-summary` - Highlighted summary box
- `.reason-item` - Individual reason styling
- `.explanation-actions` - Next actions styling

**JavaScript Rendering:**
```javascript
// Render explanation if provided
if (data.explanation) {
    const exp = data.explanation;
    // Render summary, reasons, and next actions dynamically
}
```

## User Experience

### Before
Users saw raw insights but didn't understand WHY:
```
TOTAL_SPEND: Your total spend is $2,350.00 across 5 orders.
Insights:
‚Ä¢ Total spend across 5 purchase orders: $2,350.00
‚Ä¢ 0 orders have been completed
‚Ä¢ Average order value: $470.00
```

### After
Users now see full explanation with evidence:
```
Why These Recommendations?

Summary: Your organization has spent $2,350.00 across 5 purchase orders, 
with an average order value of $470.00.

Reasons:
1. Total spend across all purchase orders
   Evidence: $2,350.00 spent across 5 orders

2. Order completion status: 0 of 5 orders completed
   Evidence: 0.0% completion rate (0 completed, 5 pending)

3. Average purchase order size indicates spending patterns
   Evidence: Average order value: $470.00 (2,350.00 √∑ 5 orders)

Next Actions:
‚úì Review pending orders (5) to track delivery and invoicing progress
‚úì Analyze spending trends by supplier to identify cost optimization opportunities
‚úì Compare current spend to budget allocation for procurement planning
```

## Rules for Explanation Generation

### ‚úÖ DO:
- Use ONLY data from the provided JSON
- Reference exact data points and calculations
- Include numerical evidence
- Provide actionable next steps
- Use business-friendly language
- Make calculations explicit (e.g., "470.00 √∑ 5 orders")
- State if data is insufficient and suggest improvements

### ‚ùå DON'T:
- Invent numbers or facts
- Make assumptions beyond the data
- Use vague language
- Skip evidence
- Provide generic advice
- Hide calculations
- Reference data not in the provided JSON

## Example Usage

### Query: "What's the total spend?"

**API Response:**
```json
{
  "intent": "total_spend",
  "answer": "Your total spend is $2,350.00 across 5 orders.",
  "insights": [
    "Total spend across 5 purchase orders: $2,350.00",
    "0 orders have been completed",
    "Average order value: $470.00"
  ],
  "data": {
    "total_spend": 2350,
    "po_count": 5,
    "completed_count": 0,
    "average_order_value": 470
  },
  "explanation": {
    "title": "Why these recommendations?",
    "summary": "Your organization has spent $2,350.00 across 5 purchase orders, with an average order value of $470.00.",
    "reasons": [
      {
        "recommendation": "Total spend across all purchase orders",
        "evidence": "$2,350.00 spent across 5 orders"
      },
      {
        "recommendation": "Order completion status: 0 of 5 orders completed",
        "evidence": "0.0% completion rate (0 completed, 5 pending)"
      },
      {
        "recommendation": "Average purchase order size indicates spending patterns",
        "evidence": "Average order value: $470.00 (2,350.00 √∑ 5 orders)"
      }
    ],
    "next_actions": [
      "Review pending orders (5) to track delivery and invoicing progress",
      "Analyze spending trends by supplier to identify cost optimization opportunities",
      "Compare current spend to budget allocation for procurement planning"
    ]
  }
}
```

## Testing

Run the test script to verify the feature:

```bash
python test_explanation.py
```

**Output includes:**
- ‚úì Explanation generation
- ‚úì Data evidence validation
- ‚úì Format compliance
- ‚úì Next actions suggestions

## Future Enhancements

1. **Multi-language Support**
   - Spanish, German, French explanations
   - Cultural context adaptation

2. **Advanced Analysis**
   - Trend-based reasoning ("spend increasing 15% month-over-month")
   - Risk-level explanations ("critical alerts" vs "informational")

3. **Customization**
   - User-defined evidence depth
   - Technical vs executive summaries
   - Industry-specific terminology

4. **Integration**
   - Email explanation summaries
   - PDF report generation
   - Slack/Teams notifications

## Compliance & Governance

‚úÖ **Transparency**
- All recommendations traceable to source data
- No hidden calculations or assumptions

‚úÖ **Auditability**
- Full data lineage for each recommendation
- Exact evidence references

‚úÖ **Data Privacy**
- No external data sources
- Uses only internal ERPNext data
- No ML/AI bias concerns

‚úÖ **Reliability**
- Deterministic explanations (same query = same explanation)
- No randomization or approximations
- Real-time data accuracy
